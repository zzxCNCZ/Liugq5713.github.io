# CDN

> A content delivery network (CDN) is a system of distributed servers (network) that deliver pages and other web content to a user, based on the geographic locations of the user, the origin of the webpage and the content delivery server.

CDN 即内容分发网络（Content Delivery Network）的简称，是建立在承载网基础上的虚拟分布式网络，能够将源站内容（包括各类动静态资源）智能缓存到全球各节点服务器上。这样不仅方便了用户就近获取内容，提高了资源的访问速度，也分担了源站压力。

## 加速域名

加速域名指需要使用 CDN 加速的域名。加速域名也是一个域名。加速域名一般配置 CNAME 记录，指向 CDN 网络节点。普通域名一般配置 A 记录，指向提供服务的业务服务器。

## CNAME 记录、 A 记录和 NS 记录

DNS ( Domain Name System，域名系统)提供了将域名转换为 IP 地址的服务。为了完成这个转化工作，DNS 的数据库中需要维护相关的数据，这些数据被叫做 RR（Resource Record，资源记录）。资源记录有很多种类型，比如 A、NS、SOA、CNAME 和 PTR 记录。

大家接触最多的就是 A（Address）记录。A 记录是一条从域名到 IP 地址的映射记录。而 CNAME（Canonical Name）记录是一条从域名到域名的映射记录。它在 CDN 技术中有举足轻重的作用，很好地实现了业务域名与 CDN 系统域名的解耦。简单理解，如果一个域名配置了 A 记录，DNS 就会把它解析成 A 记录指定的 IP 地址；如果一个域名配置了 CNAME 记录，DNS 就会把它解析成 CNAME 记录指定的另外一个域名；A 记录和 CNAME 记录是互斥的，不能同时存在。CDN 解析其实是一个非常复杂的过程，更详细的信息推荐查看这篇文章：DNS 原理及其解析过程。

NS （Name Server）记录是和 DNS 服务器相关的一条记录，它指定该域名应该由哪一台 DNS 服务器进行解析。一般把通过 NS 记录指定的 DNS 服务器叫做该域名的权威 DNS 服务器。

## 源站

提供原始资源（使用 CDN 加速的资源）的业务服务器，可以指定为域名或 IP 地址。

## 回源

当 cdn 缓存服务器中没有符合客户端要求的资源的时候，缓存服务器会请求上一级缓存服务器，以此类推，直到获取到。最后如果还是没有，就会回到我们自己的服务器去获取资源。 那都有哪些时候会回源呢？没有资源，资源过期，访问的资源是不缓存资源等都会导致回

## 工作原理

假设我建立了一个网站，域名为“www.tt.com”，用户访问的主页链接为“www.tt.com/idx.html”。为了缓解服务端压力和加快访问速度，决定使用阿里云 CDN 服务。
为了更好地理解工作原理，先了解一下 CDN 的接入流程。

接入流程

主要接入步骤如下：

1. 到某域名供应商处申请一个加速域名：“js.tt.com”。
2. 到阿里云 CDN 平台添加加速域名“js.tt.com”，同时设置其源站域“www.tt.com”
3. 阿里云 CDN 平台自动分配一个 CNAME 域名：“js.tt.com.ali.com”。
4. 到域名供应商处给加速域名“js.tt.com”添加 CNAME 记录，其值为上一步得到的 CNAME 域名：“js.tt.com.ali.com”。

对以上步骤做进一步说明：

- 为了使用 CDN，必需另外再申请一个加速域名，作为使用 CDN 的入口。
- 加速域名配置的是 CNAME 记录，值为 CDN 平台提供的 CNAME 域名，该 CNAME 域名指向 CDN 系统节点。
- 添加加速域名时需要配置源站域名，据此，CDN 平台保存了加速域名与源站域名的映射关系。
- CNAME 域名的格式一般是：<加速域名> + <供应商主域名>。

## CDN 系统架构

从功能上看，典型的 CDN 系统由分发服务系统、负载均衡系统和运营管理系统组成。分发服务系统主要负责资源的响应、缓存和同步。负载均衡系统主要负责对用户请求进行调度。运营管理系统则负责运营需求管理和网络系统管理。
从节点分布上看，CDN 系统主要分为边缘层和中心层。边缘层分布在 CDN 网络的边缘位置，给用户提供就近访问服务。中心层则负责完成资源同步和运营管理等功能。中心层保存了加速域名的相关配置信息，比如源站域名，也缓存了加速域名下的各种资源。在边缘层节点未命中缓存时，需要向中心层节点发起请求；而中心层节点未能命中缓存时，需要查找对应的源站域名，并向该源站域名发起请求。然后再逐层返回并缓存用户请求的资源。

## CDN 缓存

CDN 缓存有效地提升了访问速度，但是也带来了文件无法及时更新的问题。一般通过 Hash 字符串的方式来解决这个问题。在每个文件名后面加一个 hash 字符串，每次发布的静态资源的文件名都不一样，相应的访问 URL 也不一样，这样就不会命中缓存。这种方式对 CSS 和 JS 文件很好使，但是对 HTML 文件就不合适了。CSS 和 JS 文件名是写在 HTML 文件中的，文件名的替换由 Webpack 自动完成的。用户访问某个网站时，一般会重定向到主页面。也就是说，HTML 文件名一般是重定向时决定的，需要在重定向的路由中配置，比如 nginx 配置文件，替换工作基本手动完成。每次发布后都需要手动修改 nginx 配置，才能使用户访问最新的 HTML 文件，这显然是不可行的。所以，Hash 字符串的办法不适用于 HTML 文件。

因此，HTML 文件需要另外部署。

## 参考

ps: 该文章来自公司内部，但是不能直接贴链接，所以将原文内容复制到此

- [关于 cdn、回源等问题一网打尽](https://juejin.im/post/5af46498f265da0b8d41f6a3)
- [DNS 解析的过程是什么，求详细的？](https://www.zhihu.com/question/23042131/answer/66571369)
