# 关键渲染路径

::: tip 解释

关键渲染路径(Critical Rendering Path)：是指浏览器呈现网页要经历的一系列步骤
:::

## HTML -> DOM

字节 → 字符 → 令牌 → 节点 → 对象模型，生成了文档对象模型

HTML response > Tokens > Nodes > DOM Tree

浏览器会**逐步构建 DOM**,通过这一点来优化生成网页的速度。即不用等所有 HTML 的都好了之后在处理，返回部分 HTML 是个很好的性能优化策略

## CSS -> CSSOM

因为 CSS 会依据层级关系重新定义和优化样式属性,如果使用 CSS 部分树，会导致网页的样式渲染不正常，所以浏览器需解析全部资源内容才能进行渲染树的构建。即 CSS 为一种渲染阻塞资源(render blocking resource)

**CSS 是阻塞渲染的资源。需要将它尽早、尽快地下载到客户端，以便缩短首次渲染的时间**

## Render Tree

渲染树(CSSOM 树和 DOM 树合并)最重要的特性就是仅捕获可见内容。渲染树是 DOM 和 CSSOM 的结合，是最终能渲染到页面的元素的树形结构表示。也就是说，它包含能在**页面中最终呈现的元素**，而不包含那些用 CSS 样式隐藏的元素，比如带有 display: none;属性的元素。

## Layout

根据渲染树来布局，以计算每个节点的几何信息,将各个节点绘制到屏幕上

`<meta name="viewport" content="width=device-width, initial-scale=1">`

告诉浏览器布局视口的宽度应该等于设备的宽度，如果没有设置，浏览器就会使用默认视口宽度 980px

## JavaScript

JavaScript 允许我们修改网页的方方面面：内容、样式以及它如何响应用户交互。 不过，**JavaScript 也会阻止 DOM 构建和延缓网页渲染**

- JavaScript 可以查询和修改 DOM 与 CSSOM
- JavaScript 执行会阻止 CSSOM。
- 除非将 JavaScript 显式声明为异步，否则它会阻止构建 DOM

### Javascript 为什么放在页面底部

我们的脚本在文档的何处插入，就在何处执行。当 HTML 解析器遇到一个 script 标记时，它会暂停构建 DOM，将控制权移交给 JavaScript 引擎；等 JavaScript 引擎运行完毕，浏览器会从中断的地方恢复 DOM 构建。

换言之，我们的脚本块找不到网页中任何靠后的元素，因为它们尚未接受处理！或者，稍微换个说法：执行我们的内联脚本会阻止 DOM 构建，也就延缓了首次渲染。

::: tip 如果浏览器尚未完成 CSSOM 的下载和构建，而我们却想在此时运行脚本，会怎样？

答案很简单，对性能不利：浏览器将延迟脚本执行和 DOM 构建，直至其完成 CSSOM 的下载和构建

向 script 标记添加异步关键字可以指示浏览器在等待脚本可用期间不阻止 DOM 构建，这样可以显著提升性能，eg: `<script src="app.js" async></script>`

:::

## 重排和重绘

- 重排：部分渲染树（或者整个渲染树）需要重新分析并且节点尺寸需要重新计算
- 重绘：由于节点的几何属性发生改变或者由于样式发生改变，例如改变元素背景色时，屏幕上的部分内容需要更新

### 触发重排和重绘

- 添加、删除、更新 DOM 节点
- 通过 display: none 隐藏一个 DOM 节点-触发重排和重绘
- 通过 visibility: hidden 隐藏一个 DOM 节点-只触发重绘，因为没有几何变化
- 移动或者给页面中的 DOM 节点添加动画
- 添加一个样式表，调整样式属性
- 用户行为，例如调整窗口大小，改变字号，或者滚动

### 优化

- 不要逐个变样式。对于静态页面来说，明智且兼具可维护性的做法是改变类名而不是样式
- “离线”的批量改变和表现 DOM。“离线”意味着不在当前的 DOM 树中做修改。你可以：
  - 通过 documentFragment 来保留临时变动
  - 复制你即将更新的节点，在副本上工作，然后将之前的节点和新节点交换
  - 通过 display:none 属性隐藏元素（只有一次重排重绘），添加足够多的变更后，通过 display 属性显示（另一次重排重绘）。通过这种方式即使大量变更也只触发两次重排
- 通常情况下，考虑一下渲染树和变更后需要重新验证的消耗。举个例子，使用绝对定位会使得该元素单独成为渲染树中 body 的一个子元素，所以当你对其添加动画时，它不会对其它节点造成太多影响。当你在这些节点上放置这个元素时，一些其它在这个区域内的节点可能需要重绘，但是不需要重排。

## 参考

- [Google 关键渲染路径文档](https://developers.google.com/web/fundamentals/performance/critical-rendering-path/?hl=zh-cn)
